---
layout:     post
title:      "macOS 踩坑日志"
subtitle:   "🤔 \"像你这样爱折腾的人，我们一般建议用Arch\" "
date:       2022-01-28 12:00:00
author:     "Shicong Liu"
header-img: "img/home-dark.jpg"
catalog: true
mathjax: true
comment: true
tags:
    - 生活
    - 日志
    - feed
---



上一台Windows笔记本已经用了五年了，但实际上最后一年里我已经很少使用。购买时正赶上计算机硬件的快速迭代时间，那是2016年，很难想象那时SSD硬盘都没有完全普及，安装SSD的电脑也大部分采用旧接口，并不兼容新版的`NVMe`硬盘。很不巧我买的型号就不支持，经过一次SSD和内存扩容后性能仍然捉襟见肘。

我并不讨厌Windows系统，相反，如果让我选出一个我用着最舒服的，评价最高的操作系统，我毫无疑问地会选择`Windows 11`，因为Windows 11集成了众多新特性，最让我感到满意的则是原生安卓应用支持和WSL中Linux区域可以直接通过资源管理器访问。除此之外，`wsl2`基本囊括了一个完整Linux操作系统日常需要的所有功能，这也使得我没有必要再安装一个Linux系统来切换。

不过`Windows 11`采用了一种强硬的态度，对`TPM`芯片强制要求导致我的旧电脑不能安装win11，此外原电脑在win10上的表现已经比较糟糕，且16英寸的廉价1080P屏幕、已经损坏了部分功能按键（`LCTRL`，`ESC`）等问题积重难返，我决定就直接买一台新的作为主力机，旧电脑则完成一些只有Windows上才能实现的功能，例如一些平台限定软件。这里就不得不提到猪王对MacBook Pro作为2022年度笔记本的个人评价[^1]，念在手里暂时有几分闲钱，理财这方面属实力不从心，那不如直接消费，梭哈是一种智慧🤔。

> 始于 `2022-01-13 17:36:56`

<br><br>

## 1. 基本设置

我在第二天就拿到了京东购买的MacBook Pro 14，这个过程多少有一些为冲动消费的后悔，毕竟我今年总共拿到的可支配金额只有`￥33000`左右，这一个设备就消耗了一半。机器激活大约需要半小时左右，设备会连接网络做出必要的更新。整个磁盘空间为`495 GB`，系统会占用`15 GB`左右，其余空间我们就要开始自行分配了。

根据我的日常使用需求，安装APP与原因列表如下

- 腾讯会议。~~生产力工具~~。
- QQ，微信，网易云，IINA。日常通讯和娱乐。
- Office套，PDF Reader，MacTeX[^2]，TeX Studio，Typora[^3]，GoodNotes。日常读论文、码字需求，以及iPad同步，随便写写等。
- ~~向日葵~~，VNC，Parallels Client。与Windows或其他Linux机器连接使用。这里我们提前在云服务器上配置了FRPS，采用代理方式进行RDP控制Windows机器。
- The Unarchiver，Transmission，Scroll Reverser，Shadow Socks。实用工具系列。
- Xcode，GitHub Desktop，iTerm，VS Code，MATLAB。桌面开发工具，其中Xcode我们并不使用，但是其工具链十分重要，空间紧张的条件下可以只保留其工具链部分，删除窗口程序。

目前安装的APP就是这些，其他的一些日常需要使用的APP就看个人需求了。除了这些之外有一些值得细说的内容，也许会帮到未来的我，也有可能会帮到更多人吧（大概）。

<br><br>

## 2. 包管理

严格来讲，类Unix系统总会采用一个包管理程序来灵活地管理软件包的安装与卸载。常见的有**Debian**系上面的`apt`，**CentOS**上的`yum`，**Arch**上的`pacman`等。每个发行版不一定只有一个包管理软件，**macOS**中实际上就有许多不同的管理器。

当然这些只需了解，只要你是一个Mac用户，你只需要安装`brew`[^brew]就可以了（笑

安装过程需要github上的配置文件，我们可以采用下面[一些碎碎念](#一些碎碎念)中的第一个栏目中的方案解决，也可以采用国内gitee源，安装方法为

```shell
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

有关homebrew的更多介绍，我们可以在官网中查看，但homebrew是我们开发的基础，后面的许多配置都依赖于这个包管理程序。

<br><br>

## 3. 触摸板与鼠标适配

我实在是没想到这一部分需要我单独写一个Section，但macOS这样我行我素实在是反人类（当然 也许是我果粉程度还不够高😓

Windows用户已经习惯了触摸板双指滑动为自然方式，而鼠标滚轮为反向方式，但是在macOS中这两个操作是绑定的。一方选择了滚动方式之后另一方必须相同。下载Scroll Reverser软件，如图配置即可

![scroll1](/img/in-post/macOS-trial/scroll1.png){:height="65%" width="65%"}

![scroll2](/img/in-post/macOS-trial/scroll2.png){:height="65%" width="65%"}

<br><br>

## 4. 终端美化

作为用终端吃饭的人，终端不美怎么行呢。原版的zsh比较简陋，甚至不能改字体，这里我先用一个新的终端软件来替换，然后再在这个新终端的基础上来定制一下

### 4.1 iTerm

直接下载[iTerm2](https://iterm2.com/)[^iterm]，安装后采用iTerm作为终端即可

> 快捷键设置

在偏好设置的Profiles里面新建一个任意名字的profile，并将其设为默认。在其中的keys下配置hotkey window，我将快捷键设置为了`control+P`

![hotkey](/img/in-post/macOS-trial/hotkey.png){:height="65%" width="65%"}





> 配色方案

现将默认的主题（`Appearance`菜单）改为`Minimal`，然后直接下载已经发行的配色方案[^themes]。适用于iTerm2的配色方案在`schemes`目录下，这里我选了`Cyber Punk`的颜色。顺带一提，关于终端的其他配置，我们可以自己在`Profiles`里面设置。





> Shell Integration

执行

```shell
curl -L https://iterm2.com/misc/install_shell_integration.sh | zsh
```

此时我们需要根据返回信息修改zsh初始化脚本，在我安装时提示让我写入的信息为

```shell
test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"
```

默认`.zshrc`就在`~`目录下，直接修改即可





相关内容可以在中文互联网比较方便地找到，例如[iTerm2 都不会用，还敢自称老司机？](https://zhuanlan.zhihu.com/p/112383265)[^refiterm]



### 4.2 Oh My ZSH

配置这一步就是图一手`Agnoster`的`powerline`，安装方式

```shell
sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
```

然后按照上面的设置将主题改为

```shell
ZSH_THEME="agnoster"
```

这里要注意，我们需要安装`Nerd Font`字体，这里我选择了`Consolas NF`字体[^nffont]，安装后在iTerm设置中选择该字体并重启终端即可。

<br><br>

## 5. 炼丹师入门

炼丹工作不是你想不想做的问题，而是全中国高校老板争着让你做的问题。为了保证炼丹程序的本地测试可以运行，我需要安装可以正常使用的pytorch。由于Anaconda的商业化问题，很多人开始从anaconda的包管理转向采用miniconda的包管理模式，不过安装包仍然通过anaconda来提供。anaconda渠道更新的包并没有原生支持`aarch64`架构（`arm64`实际上和`aarch64`是同一个东西，只是苹果采用LLVM，其他安卓设备采用GNU GCC，只在命名上稍有区别），因此一部分人转向对`miniforge`的维护，主要包都来源于`conda-forge`渠道，从而支持`aarch64`的ARM芯片，主要用于安卓等系统开发。

这里我们采用`miniforge`，安装时可以通过[https://github.com/conda-forge/miniforge](https://github.com/conda-forge/miniforge)链接下载对应[`Apple Silicon`](https://github.com/conda-forge/miniforge/releases/download/4.11.0-0/Mambaforge-4.11.0-0-MacOSX-arm64.sh)的版本（默认采用Python 3.9.1，因为之前的版本均不支持ARM芯片）。截至我安装的时候，miniforge已经以`mambaforge`的名字发布。随后用sh命令运行，像miniconda一样正常安装。重启终端之后我们应该就可以正常使用，一般会自动为zsh配置source。

这时我们就可以正常安装torch了，但是目前似乎torchvision和text的支持并没有完全解决，不过我平时几乎用不到，因此没有跟进。

<br><br>

## 6. FRP实现内网穿透

### 6.1 Windows RDP

腾讯云新用户优惠很多，且同一个人可以用QQ、微信和邮箱进行三次白嫖。客户经理推荐的适合个人的配置，相比阿里云的新用户99包年配置这个更香。这里我选择直接购买三年2核4G套餐

![image-20211216222047429](/img/in-post/macOS-trial/image-20211216222047429.png){:height="65%" width="65%"}

最近快放假了，准备一下内网反代以便假期白嫖算力。这里选择简单的`FRP`方案，下载地址在GitHub的release[页面](https://github.com/fatedier/frp/releases)

这里腾讯云是Ubuntu 20.04 LTS，被控本地机为Windows 11。windows端下载后解压缩，修改客户端配置文件`frpc.ini`

```ini
[common]
server_addr = # server public IP
server_port = 7000

[<User Name>]
type = tcp
local_ip = 127.0.0.1
local_port = 3389
remote_port = 36253
```

然后在地址栏呼出`cmd`/`pwsh`，输入命令

```shell
frpc.exe -c frpc.ini
```

此后本地的frpc就会循环尝试连接指定的服务器公网ip，直到成功连接为止。接着我们在服务器系统上下载Linux版，配置`frps.ini`文件，监听端口为7000与内网机对应，并且要记得<mark>手动放行服务器上的36253端口</mark>哦。此后在服务器注册为服务，从而可以开机自动启动并记录日志

> 官方文档给的端口6000日常被各种公网机器爆破，这里我们改成10000以上的端口，相对安全些。

建立服务

```shell
sudo vim /lib/systemd/system/frps.service
```

配置服务

```ini
[Unit]
Description=fraps service
After=network.target syslog.target
Wants=network.target

[Service]
Type=simple
# frps file location
ExecStart=/your/path/frps -c /your/path/frps.ini

[Install]
WantedBy=multi-user.target
```

启动服务

```shell
sudo systemctl start frps
```

开启/关闭开机自启动，重启服务，停止服务，服务日志分别如下

```shell
sudo systemctl enable frps
sudo systemctl disable frps
sudo systemctl restart frps
sudo systemctl stop frps
sudo systemctl status frps
```

服务器上运行并且开启开机自启动后，内网机上运行

```powershell
frpc.exe -c frpc.ini
```

此后可以直接用RDP连接

![image-20220107144235229](/img/in-post/macOS-trial/image-20220107144235229.png){:height="75%" width="75%"}

Windows上采用自带RDP服务，macOS上我们则使用`Parallels Client`这个轻量级APP进行远程。

<br>

### 6.2 VSCode SSH

除了通过云服务器设置RDP以外，最常见的一种应用方式就是穿透转发ssh的连接。我的内网机是一台`win11`的机器，安装了`OpenSSH`的服务端，首先进入`service.msc`管理服务，手动将`OpenSSH`开头的两个服务改成自动运行，并且第一次我们采用手动启动的方式强制启动。

本机的`frpc.ini`配置中又要增加一项了

```ini
[common]
server_addr = # server public IP
server_port = 7000

[<User Name>]
type = tcp
local_ip = 127.0.0.1
local_port = 3389
remote_port = 36253

[ssh]
type = tcp
local_ip = 127.0.0.1
local_port = 22
remote_port = 6001
```

同样要记得<mark>手动放行服务器上的6001端口</mark>。然后我们重启内网机中的`frpc`，重启命令与上面的运行命令相同，主要是刷新一下程序的配置信息，然后我们可以在公网机上通过ssh直接连接内网机：

```shell
ssh -p 6001 <private machine username>@<server public IP>
```

关于ssh的详细内容就不细说了，简单指路

- 如果内网机用户名有空格，请采用配置config文件的方式登录[^configssh]
- FRP官方文档[^frpdoc]

前面的命令可以正常连接之后，我们打开外网机vscode中的远程插件，在配置文件里写入

```
Host <casual host name>
  HostName <server public IP>
  Port 6001
  User <private machine username>
```

然后开始点击远程按钮开始远程。一般来说Windows远程机都会以用户名密码来配置，就不再赘述密钥对的问题。

<br><br>

## 7. 博客运营相关

> 官方文档懂个球，真debug还得看我CSDN

本博客来自于`Huxpro`[^huxpro]的模板，和其他`jekyll`静态页面博客一样只需要`bundle`一下就可以运行本地调试了。bundle指令运行很随意，例如切换到我们master目录下之后直接

```shell
bundle install
```

即可，但是即使正确安装未报错（其实报错了，但是我没注意），在通过如下命令启动服务的时候却报错了

```shell
bundle exec jekyll serve --trace
```

报错最终定位到了`ffi`这个库上，我查阅了一些相关资料，有人提到在安装`pod`的时候也出现了类似的问题。他们的解决方案是通过安装`x86_64`架构的包解决问题[^ffi]，虽然不知道他为什么成功了，但是如果想要项目降回`x86_64`应该需要所有库都改用此架构才行，`arm64`和`x86_64`混用本身就是不合理的。

此后经过多方查证，还是在官方文档[^docjekyll]里解决了问题。

并非M1的兼容问题，早在很久前这些模块就已经提供了丰富的arm64交叉编译二进制文件，相比繁多的x86型号处理器及指令集，M1系列芯片的适配反而没有那么困难。一些人提到通过如下命令安装`x86_64`的库文件，然而这是错误的，错误示范：

```shell
sudo arch -x86_64 gem install ffi
```

可以明显看出该博主的ruby目录就是错误的，我们不应该拥有这个ruby目录下的读写权限，如果进行sudo使用（实际上程序本身也会报错，提示不要使用root权限账号运行）会带来不可知的后果。

因此应该采用brew管理外部ruby并在zsh中添加环境变量支持，此后我们使用zsh的时候ruby就会默认为此（详见jekyll官网）

```shell
echo 'export PATH="/opt/homebrew/opt/ruby/bin:$PATH"' >> ~/.zshrc
```

最后需要说明，默认安装的ruby 3.0不再捆绑webrick，需要手动添加

```shell
bundle add webrick
```

此时开启本地调试只需要如下命令之一即可。

```shell
bundle exec jekyll serve --trace
npm start
```

<br><br>

## 8. 一些碎碎念


### 8.1 GitHub部分功能国内无法使用

这个可以通过改hosts的方式获取临时的GitHub access，具体方式为

```shell
sudo vim /etc/hosts
```

键入`i`在后面添加一行

```
199.232.4.133 raw.githubusercontent.com
```

Esc 后`:wq`保存

这个IP地址是来自中国香港的访问IP，至少可以通。不过国内的运营商政策限制，这个方案可能并不长久。考虑到只需要在部分配环境的过程中需要，可以在修改后快速将环境问题解决，后面我们对github的依赖就不会那么严重了。



<br>

### 8.2 安装第三方应用需谨慎。

之前安装<mark>网易云音乐</mark>的时候，App Store的版本要求我更新到最新版本。链接直接指向官方网站，我也就跟着下载了。但是后面的使用中我发现，每当我运行网易云音乐的时候（显然，我并不常用），macOS右上角的APP菜单栏的所有非系统图标就会消失。这个问题虽然不是什么大问题，但是一些基于菜单栏才能呼出窗口的软件就不能使用了，例如Shadowsocks，这为我的日常使用带来了许多困扰。

这个问题起初并不能稳定复现，但是经过我的不懈~~努力~~作死，最终在网易云这里发现了问题。对于macOS的基本原理我并不熟悉，因此前期我选择的解决方案来自英文macOS社区2017年的讨论[^10]，删除（稳妥起见我选择重命名）对应的plist文件后登出用户再登录，问题就得以解决。不过这个问题只能解决一时，自从我删除了非App Store版本的网易云后，这个问题目前还没有重现过。



<br>

### 8.3 M1性能之谜

M1这款芯片的性能在我眼中本是个谜。`x86_64`架构的处理器有着统一的评测体系，指令集的设计与ARM不能说是天壤之别吧，至少也是完全不同，拿到一起比较还是有些牵强。除了KOL对M1芯片的大力吹捧以外，我很少见到有人对M1芯片持绝对积极的态度，喜忧参半也算是中肯的评价，直到我实地体验了一下。

我是做通信算法的，大部分时间需要MATLAB来进行仿真，而截至目前（`2022-01-28 UTC+8`）MATLAB并未公布基于ARM架构开发的新版本（题外话，距离MATLAB宣布在开发已经过去8个月了），这里也是适用于`Intel`处理器的`2021b`版，代码经过`Rosetta`转译运行。

对于常规的迭代OMP算法，`i7 8700`需要运行407s左右，而`M1`芯片只需要300出头。贝叶斯类算法AMP则提升也较为明显，同样的2000轮迭代`i7`需要500s以上，`M1`芯片则只需要360s左右。经过这次测试之后我大受震撼，没想到即使在转译的条件下，新处理器也有这样强势的性能。不过台式机安装了32G内存，这是MacBook Pro丐版所不能体验的廉价优势。

相比专业计算软件，炼丹工作是几乎当今每一位研究生多少都会接触的。采用上面介绍的方式成功配置了PyTorch的ARM版后，我们可以用有限的内存做CPU炼丹验证，并通过SCP拷贝到工作站上部署。经过验证，最终测试结果M1处理器相比i7的提升也超过了20%。但是这里的i7 8700是一个台式机上满功率运行的芯片，python进程大约占据50%的CPU资源，而在macOS中，六个大核的性能已经被完全应用（MATLAB只能等效调用其中的三个核心）。

当然乐观一点我们可以说，相比跑分上的超级提升[^11]，实际体验中的差距还没有那么明显（😅）



<br>

### 8.4 外观

Pro这个系列的重新设计十分大胆，左侧双type-c，一个电源一个3.5mm耳机，右侧一个<mark>HDMI</mark>，一个type-c和一个<mark>读卡器</mark>。

看到这个设计的时候我一时间无话可说，因为HDMI在这类笔记本上很久前就不存在了，而MacBook Air上则非常直白地删去了大部分接口，不知道为什么这样激进的设计师又选择加回来了这些怪异的接口。尤其是读卡器，我已经很久没在笔记本上见过读卡器了，而且我本人几乎也从来没有用过（😅）。

如果需要外接存储器扩展（移动硬盘，U盘等），外接网线（通信联调经常要接网线），就必须要扩展坞。个人感觉右侧读卡器这里换个USB应该没有什么大问题，不过苹果设计师我行我素这么多年了，李姐。

<br>



### 8.5 Jupyter Notebook on VS Code

`Jupyter Notebook`在`VS Code`上的嵌入编辑器显示图片时总是只显示一个图像的对象信息，而不显示图像，例如

```
<matplotlib.colorbar.Colorbar at 0x1668ba6a0>
<Figure size 432x288 with 2 Axes>
```

我研究了多种`inline`渲染方法均不成功，最后发现点击左侧`</>`图标后可以自选显示方式。最后在`VS Code`的`Notebook`设置中找到选项[^mimetype]，在json中添加

```json
"notebook.displayOrder": ["image/png", "text/plain"]
```

即可解决。

<br>

### 8.6 VS Code 远程bug

今日使用`VS Code`远程运行`ipynb`的时候提示`Intel MKL`库没有找到。实际上安装`torch`的时候就会自动配置`mkl`，我也很明确这台电脑上是有的，于是RDP远程上去看情况，RDP本地运行正常。然后重新回到Mac机，在`VS Code`里面的`pwsh`中手动进入`Python`环境测试，仍然没有问题。最后在`pwsh`中==pip==重新安装了提示报错的`numpy,h5py,matplotlib`之后问题解决。

<br>

### 8.7 邮箱异常占用CPU、高能耗以及频繁下载邮件问题

频繁CPU占用以及高能耗是因为曾经邮箱接收或发送过超大附件，一些私有协议与Apple Mail APP不兼容（垃圾APP），所以需要设置

- 将所有draft保存在Mac本地 （解决频繁下载问题）
- 邮件内容下载选择None
- 选定所有邮箱的inbox，然后在上方菜单选择mailbox -> rebuild

等待几分钟后能耗问题与下载问题均可解决。参考方案为reddit[^reddit_mail]




---


[^1]: [聊一款我心目中的"年度笔记本"](https://mp.weixin.qq.com/s/WmNU533CRJzcxTRmcm_gaQ)
[^2]: [TeXLive macOS version](https://tug.org/mactex/)
[^3]: [Old Typora Dev Releases](https://typora.io/releases/all)
[^brew]: [Homebrew 中文官方页面](https://brew.sh/index_zh-cn)
[^iterm]: [iTerm2](https://iterm2.com/)
[^themes]: [配色方案合集](https://iterm2colorschemes.com/)
[^refiterm]: [iTerm2 都不会用，还敢自称老司机?](https://zhuanlan.zhihu.com/p/112383265)
[^nffont]: [https://github.com/Znuff/consolas-powerline](https://github.com/Znuff/consolas-powerline)
[^configssh]: [escape-username-spaces-in-scp](https://askubuntu.com/questions/774919/escape-username-spaces-in-scp)
[^frpdoc]: [FRP](https://gofrp.org/)
[^huxpro]: [黄玄 GitHub](https://github.com/huxpro)
[^ffi]: [MacBook M1在 pod install 时出现兼容性问题](https://blog.csdn.net/shentian885/article/details/120700314)
[^docjekyll]: [Install Jekyll on Mac](https://idratherbewriting.com/documentation-theme-jekyll/mydoc_install_jekyll_on_mac.html)
[^10]: [Menu bar icons missing](https://discussions.apple.com/thread/8096922)
[^11]: [CPU Comparison](https://www.cpu-panda.com/zh-cn/compare_cpu-intel_core_i7_8700-vs-apple_m1_pro_8_cpu)
[^mimetype]:[VSCode MIMETYPE Order](https://code.visualstudio.com/updates/v1_62)
[^reddit_mail]:[Mail causing significant energy usage/power drain/overheating air m1](https://www.reddit.com/r/MacOS/comments/rwjox4/mail_causing_significant_energy_usagepower/)
